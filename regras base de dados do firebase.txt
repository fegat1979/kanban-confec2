regras do base de dados do firebase - Kanban3

==== IN√çCIO DO C√ìDGIGO ====

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isMember(boardId) {
      // "exists" n√£o exige permiss√£o de leitura ‚Äî funciona para checar membership
      return isSignedIn()
        && exists(/databases/$(database)/documents/boards/$(boardId)/members/$(request.auth.uid));
    }
    function role(boardId) {
      // "get" exige permiss√£o de leitura do doc de membro ‚Äî por isso liberamos "read" abaixo
      return get(/databases/$(database)/documents/boards/$(boardId)/members/$(request.auth.uid)).data.role;
    }

    match /boards/{boardId} {
      // üëá S√≥ membros podem LER o board e seus cards
      allow read: if isMember(boardId);

      // ===== Subcole√ß√µes =====
      // Cards: membros leem; s√≥ admin/editor escrevem
      match /cards/{cardId} {
        allow read: if isMember(boardId);
        allow create, update, delete: if isMember(boardId) && (role(boardId) in ['admin','editor']);
      }

      // Members:
      // üîë Qualquer usu√°rio logado pode LER o PR√ìPRIO doc (p/ checar role sem loop),
      //     admins podem gerenciar todos
      match /members/{uid} {
        allow read: if (isSignedIn() && request.auth.uid == uid) || isMember(boardId);
        allow create, update, delete: if isMember(boardId) && role(boardId) == 'admin';
      }

      // Pedidos de acesso: usu√°rio logado cria/consulta o pr√≥prio; admin gerencia todos
      match /joinRequests/{uid} {
        allow create: if isSignedIn() && request.auth.uid == uid;
        allow read: if (isSignedIn() && request.auth.uid == uid) || (isMember(boardId) && role(boardId) == 'admin');
        allow update, delete: if isMember(boardId) && role(boardId) == 'admin';
      }
    }
  }
}

==== FINAL DO C√ìDGIGO ====